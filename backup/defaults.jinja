{% load_yaml as defaults %}
repository:
repository_maxsize: -1
repository_password:
env: {}
includes: []
excludes: []
timer: *-*-* 00:30:00
# max time for fullbackup, eg: 5hours (equal 350GB using 20mb per Second)
maxruntime: 300min
cleanup_interval_days: 7
user:

systemd:
  after:
  wants:
  requires:
  onfailure:

hooks:
  prebackup:
    - name: assure app media_dir is mounted if media_dir is external mount
      cmd: |
          if grep -q "{{ settings.media_dir }}" /etc/fstab; then
              if ! mountpoint -q "{{ settings.media_dir }}"; then
                  sentry_entry "App Backup" "backup error: Mount at Mountpoint {{ settings.media_dir }} is not mounted"
                  exit 1
              fi
          fi
    - name: assure app media_dir is non empty
      cmd: |
          files_found=$(find "{{ settings.media_dir }}" -mindepth 1 -path "{{ settings.media_dir }}/lost+found" -prune -o -type f -exec echo true \; -quit)
          if test "$files_found" != "true"; then
              sentry_entry "App Backup" "backup error: media_dir {{ settings.media_dir }} is empty"
              exit 1
          fi
    - name: assure database exists
      cmd: |
          for i in
          psql -lqt | cut -d \| -f 1 | grep -qw "$DATABASE" && err=$? || err=$?
          if test $err -ne 0; then
              sentry_entry "App Backup" "backup error: Database $DATABASE does not exist"
              exit 1
          fi
    - name: dump database
      cmd: |
          dbdump="{{ settings.pgdump_dir }}/$DATABASE.pgdump.gz"
          duration_start=$(date +%s)
          /usr/bin/pg_dump --encoding='utf-8' --format=custom -Z0 -d "$DATABASE" | \
              /bin/gzip --rsyncable > "${dbdump}.new" && err=$? || err=$?
          duration_pg_dump=$(( $(date +%s) - duration_start ))
          if test "$err" -ne 0; then
              sentry_entry "App Backup" "backup error: could not create database dump" \
                  "error" "$(systemd_json_status app-backup.service)"
              exit 1
          fi
          mv "${dbdump}.new" "${dbdump}"

{% endload %}

{%- set settings = salt['grains.filter_by']({'default': defaults},
  grain='default', default= 'default', merge= salt['pillar.get']('backup', {})) %}
