From 2a3771ce3c4d91316052ac6b6442ef5f58cce5e0 Mon Sep 17 00:00:00 2001
From: Pavel Snajdr <snajpa@snajpa.net>
Date: Sat, 5 Oct 2019 02:07:22 +0200
Subject: [PATCH 12/13] [vpsAdminOS] Hide ZFS from container tools

---
 include/sys/fs/zfs.h             |  1 +
 module/os/linux/zfs/zfs_vfsops.c | 12 ++++++++++++
 2 files changed, 13 insertions(+)

diff --git a/include/sys/fs/zfs.h b/include/sys/fs/zfs.h
index aa20a8c5c..ea024c306 100644
--- a/include/sys/fs/zfs.h
+++ b/include/sys/fs/zfs.h
@@ -1149,6 +1149,7 @@ typedef struct ddt_histogram {
 #define	ZFS_SHARETAB	"/etc/dfs/sharetab"
 
 #define	ZFS_SUPER_MAGIC	0x2fc12fc1
+#define	ZFS_SHACK_MAGIC	0x13372fc1
 
 /* general zvol path */
 #define	ZVOL_DIR	"/dev"
diff --git a/module/os/linux/zfs/zfs_vfsops.c b/module/os/linux/zfs/zfs_vfsops.c
index 32e3bba40..e015a7ffe 100644
--- a/module/os/linux/zfs/zfs_vfsops.c
+++ b/module/os/linux/zfs/zfs_vfsops.c
@@ -1089,6 +1089,7 @@ zfs_statvfs(struct dentry *dentry, struct kstatfs *statp)
 	zfsvfs_t *zfsvfs = dentry->d_sb->s_fs_info;
 	uint64_t refdbytes, availbytes, usedobjs, availobjs;
 	int err = 0;
+	bool magic_hack = false;
 
 	ZFS_ENTER(zfsvfs);
 
@@ -1136,6 +1137,17 @@ zfs_statvfs(struct dentry *dentry, struct kstatfs *statp)
 	statp->f_type = ZFS_SUPER_MAGIC;
 	statp->f_namelen = MAXNAMELEN - 1;
 
+	if (strcmp(current->comm, "containerd") == 0)
+		magic_hack = true;
+	if (strcmp(current->comm, "dockerd") == 0)
+		magic_hack = true;
+	if (strcmp(current->comm, "lxd") == 0)
+		magic_hack = true;
+	if (magic_hack) {
+		printk(KERN_INFO "ZFS magic faked to %s\n", current->comm);
+		statp->f_type = ZFS_SHACK_MAGIC;
+	}
+
 	/*
 	 * We have all of 40 characters to stuff a string here.
 	 * Is there anything useful we could/should provide?
-- 
2.20.1

