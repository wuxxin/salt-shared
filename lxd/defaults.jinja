{% set ipaddr= "10.140.222.1" %}
{% set netsize= "24" %}
{% set bridge= "lxdbr0" %}
{% set pool= "default" %}

{% load_yaml as defaults %}

# Daemon settings
config:
  core.https_address: 127.0.0.1
  images.auto_update_interval: 15

# Storage pools
storage_pools:
- name: {{ pool }}
  description: LXD {{ pool }} pool
  driver: dir
  config:     
    source: /var/lib/lxd/storage-pools/{{ pool }}

# self managed Network devices
networks:
- name: {{ bridge }}
  type: bridge
  config:
    ipv4.address: {{ ipaddr }}/{{ netsize }}
    ipv4.nat: true
    ipv6.address: none
    # needed parameter to prevent dns loop and point host dns to lxd for *.lxd
    raw.dnsmasq: |
        auth-zone=lxd
        dns-loop-detect

# Profiles
profiles:
- name: default
  description: Default LXD profile
  devices:
    eth0:
      nictype: bridged
      parent: {{ bridge }}
      type: nic
    root:
      path: /
      pool: {{ pool }}
      type: disk
- name: autostart
  config:
    boot.autostart: true
    boot.autostart.delay: 2
- name: nested
  config:
    security.nesting: true
- name: gui
  config:
    environment.DISPLAY: :0
    raw.idmap: both 1000 1000
    user.user-data: |
      #cloud-config
      runcmd:
        - 'sed -i "s/; enable-shm = yes/enable-shm = no/g" /etc/pulse/client.conf'
        - 'echo export PULSE_SERVER=unix:/tmp/.pulse-native | tee --append /home/ubuntu/.profile'
      packages:
        - x11-apps
        - mesa-utils
        - pulseaudio
  description: LXD Gui Profile
  devices:
    PASocket:
      path: /tmp/.pulse-native
      source: /run/user/1000/pulse/native
      type: disk
    X0:
      path: /tmp/.X11-unix/X0
      source: /tmp/.X11-unix/X0
      type: disk
    mygpu:
      type: gpu

# Images
images:
- name: bionic
  public: true
  auto_update: true
  source:
    name: bionic/amd64
    remote: ubuntu
- name: bionic-daily
  public: true
  auto_update: true
  source:
    name: bionic/amd64
    remote: ubuntu

{% endload %}


{% set settings=salt['grains.filter_by']({'none': defaults},
  grain='none', default= 'none', merge= salt['pillar.get']('lxd', {})) %}
