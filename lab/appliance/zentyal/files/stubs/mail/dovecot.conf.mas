<%args>
    $uid
    $gid

    %protocols

    $firstValidUid
    $firstValidGid
    $mailboxesDir
    $postmasterAddress

    $keytabPath
    $gssapiHostname
</%args>
<%init>
my @protocolsReduced;
if ($protocols{pop3} or $protocols{pop3s}) {
    push @protocolsReduced, 'pop3';
}
if ($protocols{imap} or $protocols{imaps}) {
    push @protocolsReduced, 'imap';
}
if ($protocols{managesieve}) {
    push @protocolsReduced, 'sieve';
}
</%init>
# Generated by Zentyal

listen = *

% if (@protocolsReduced) {
protocols = <% "@protocolsReduced" %>
% } else {
protocols = none
% }

##
## Authentication processes
##

auth_mechanisms = gssapi plain
auth_krb5_keytab = <% $keytabPath %>
auth_gssapi_hostname = <% $gssapiHostname %>
auth_debug = no
auth_verbose = no


service auth {
  executable = /usr/lib/dovecot/auth

  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    # Assuming the default Postfix user and group
    user = postfix
    group = postfix
  }

  unix_listener auth-master {
    group = ebox
    mode = 0600
    user = ebox
  }
}

service lmtp {
    unix_listener /var/spool/postfix/private/dovecot-lmtp {
        group = postfix
        mode = 0666
        user = postfix
    }
}


userdb {
    driver = ldap
    args = /etc/dovecot/dovecot-ldap.conf
    default_fields=uid=<% $uid %> gid=<% $gid %>
}

passdb {
    driver = ldap
    args = /etc/dovecot/dovecot-ldap.conf
}

disable_plaintext_auth = yes

##
## Logging
##

log_timestamp = "%Y-%m-%d %H:%M:%S "

##
## SSL settings
##

ssl = yes
ssl_cert = </etc/dovecot/private/dovecot.pem
ssl_key = </etc/dovecot/private/dovecot.pem
# DH parameters length to use.
ssl_dh_parameters_length = 2048
# XXX ssl_dh will be set in mail.postsetconf
#ssl_dh = </app/etc/dhparam.pem
# SSL protocols to use
ssl_protocols = TLSv1.2, TLSv1.1, !TLSv1, !SSLv3, !SSLv2
# SSL ciphers to use
ssl_cipher_list = ALL:!LOW:!SSLv2:!SSLv3:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!3DES:!PSK
# Prefer the server's order of ciphers over client's.
ssl_prefer_server_ciphers = yes
# SSL extra options. Currently supported options are:
#   no_compression - Disable compression.
ssl_options = no_compression

verbose_ssl = no

##
## Login processes
##

##
## Mailbox locations and namespaces
##

mail_uid=<% $uid %>
mail_gid=<% $gid %>

namespace inbox {
    inbox=yes
    separator = /

    mailbox Trash {
        auto = subscribe
        special_use = \Trash
    }

    mailbox Drafts {
        auto = subscribe
        special_use = \Drafts
    }

    mailbox Sent {
        auto = subscribe
        special_use = \Sent
    }

    mailbox "Sent Messages" {
        auto = no
        special_use = \Sent
    }

    mailbox Spam {
        auto = create
        special_use = \Junk
    }

    subscriptions = yes
}

##
## Mail processes
##
mail_debug = no

mail_uid = ebox
mail_gid = ebox
first_valid_uid = <% $firstValidUid %>
first_valid_gid = <% $firstValidGid %>


##
## Mailbox handling optimizations
##

##
## Maildir-specific settings
##
# bef mail_location = maildir:<% $mailboxesDir %>/%$
mail_location = maildir:<% $mailboxesDir %>/%d/%u/Maildir
mail_home     = <% $mailboxesDir %>/%d/%u
##
## mbox-specific settings
##

##
## dbox-specific settings
##
% if ($protocols{'imap'} or $protocols{'imaps'}) {
   <& .imap,
      imap => $protocols{'imap'},
      imaps => $protocols{'imaps'},
   &>
% }

% if ($protocols{'pop3'} or $protocols{'pop3s'}) {
   <& .pop3,
      pop3 => $protocols{'pop3'},
      pop3s => $protocols{'pop3s'},
   &>
% }

<& .managesieve,
   enabled => $protocols{'managesieve'}
&>


##
## LDA specific settings
##
protocol lda {
  # Address to use when sending rejection mails.
  postmaster_address = <% $postmasterAddress %>

  # UNIX socket path to master authentication server to find users.
  auth_socket_path = /var/run/dovecot/auth-master

  # Enabling Sieve plugin for server-side mail filtering and quota for quota
  # support
  mail_plugins = sieve quota
}

##
## Dictionary server settings
##
dict {
  #quota = mysql:/etc/dovecot/dovecot-dict-quota.conf
  #expire = db:/var/lib/dovecot/expire.db
}

##
## Plugin settings
##
plugin {
  quota = maildir:User quota
  quota_rule = *:storage=0

  sieve = <% $mailboxesDir %>/%Ld/%Ln/sieve-script
  sieve_global_path = <% $mailboxesDir %>/default.sieve
  sieve_storage = <% $mailboxesDir %>/%Ld/%Ln
  sieve_dir     = <% $mailboxesDir %>/%Ld/%Ln
}

!include_try /etc/dovecot/extra.conf

<%def .imap>
<%args>
$imap
$imaps
</%args>
<%init>
my $imapAddress = $imap ? '*' : '127.0.0.1';
my $imapPort = $imap ? 143: 0;
my $imapsAddress = $imaps ? '*' : '127.0.0.1';
my $imapsPort = $imaps ? 993: 0;
</%init>
##
## IMAP specific settings
##
service imap-login {
  inet_listener imap {
    address = <% $imapAddress %>
    port = <% $imapPort %>
  }
  inet_listener imaps {
    address = <% $imapsAddress %>
    port = <% $imapsPort %>
  }
}

service imap {
}

protocol imap {
  mail_plugins = quota imap_quota
  mail_max_userip_connections = 20
}
</%def>


<%def .pop3>
<%args>
$pop3
$pop3s
</%args>
<%init>
my $pop3Port = $pop3 ? 110: 0;
my $pop3sPort = $pop3s ? 995: 0;
</%init>
service pop3-login {
  inet_listener pop3 {
    port = <% $pop3Port %>
  }
  inet_listener pop3s {
    port = <% $pop3sPort %>
  }
}

service pop3 {
}

protocol pop3 {
  mail_plugins = quota
}
</%def>

<%def .managesieve >
<%args>
$enabled
</%args>
<%init>
my $port = $enabled ? 4190 : 0;
</%init>
##
## ManageSieve specific settings
##

service managesieve-login {
  inet_listener sieve {
    port = <% $port %>
  }
}

service managesieve {
}

protocol sieve {
}
</%def>
