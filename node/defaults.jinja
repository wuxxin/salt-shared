{% macro netcidr(cidr) %}{{ salt['network.convert_cidr'](cidr)['network'] }}{% endmacro %}
{% macro netmask(cidr) %}{{ salt['network.convert_cidr'](cidr)['netmask'] }}{% endmacro %}
{% macro cidr2ip(cidr) %}{{ cidr|regex_replace ('([^/]+)/.+', '\\1') }}{% endmacro %}

{% set internal_cidr = salt['pillar.get']('node:network:internal_cidr', '10.140.250.1/24') %}
{% set internal_name = salt['pillar.get']('node:network:internal_name', 'resident') %}


{# defaults #}
{% load_yaml as defaults %}
hostname:
users:
groups:

locale:
  lang: en:us
  additional:
  posix_messages: false
  timezone: Etc/UTC
  location: World

network:
  internal_cidr: {{ internal_cidr }}
  internal_name: {{ internal_name }}
  netplan:
  rpc_bind_list:
    - {{ cidr2ip(internal_cidr) }}
{% endload %}

{# merge defaults with pillar #}
{% set settings=salt['grains.filter_by']({'none': defaults},
  grain='none', default= 'none', merge= salt['pillar.get']('node', {})) %}

{# update settings.locale #}
{% set lang_name= settings.locale.lang.split(':')[0] %}
{% set lang_country= settings.locale.lang.split(':')[1] %}
{% set lang_env= lang_name+ '_'+ lang_country|upper+ '.UTF-8' %}
{% set tempspace = namespace({'lang_all': lang_env}) %}
{% if settings.locale.additional %}
  {% for x in settings.locale.additional.split(' ') %}
    {% set l = x.split(':')[0] %}
    {% set c = x.split(':')[1] %}
    {% set tobeadded = l+ '_'+ c|upper()+ '.UTF-8' %}
    {% set tempspace.lang_all= tempspace.lang_all+ ' '+ tobeadded %}
  {% endfor %}
{% endif %}
{% do settings.locale.update({
  'language': settings.locale.language|d(lang_name+ '_'+ lang_country|upper+ ':'+ lang_name),
  'language_code': lang_name+ '-'+ lang_country,
  'lang_env': lang_env,
  'lang_all': tempspace.lang_all,
  'messages_env': 'POSIX' if settings.locale.posix_messages else '',
  }) %}

{# update settings.network #}
{% do settings.network.update({
  'internal_ip': cidr2ip(settings.network.internal_cidr),
  'internal_netcidr': netcidr(settings.network.internal_cidr),
  'internal_netmask': netmask(settings.network.internal_cidr),
  }) %}
