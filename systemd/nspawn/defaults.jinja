{% load_yaml as defaults %}

store:
  nspawn_config: /etc/systemd/nspawn
  nspawn_target: /var/lib/machines
  nspawn_volume: /var/lib/volumes/nspawn
  mkosi_config: /etc/mkosi
  mkosi_cache: /var/cache/mkosi
  mkosi_target: /var/lib/mkosi

image:
  {% for distro in ['xenial', 'bionic', 'focal'] %}
  {{ distro }}:
    mkosi:
      Distribution:
        Distribution: ubuntu
        Release: {{ distro }}
        Repositories: main,universe,multiverse,restricted
      Output:
        Format: directory
        Bootable: no
        Hostname: {{ distro }}
      Packages:
        PostInstallationScript: mkosi.postinst
        NSpawnSettings: mkosi.nspawn
        Packages:
        - lsb-release
        - tzdata
        - iproute2
        - iputils-ping
        - openssh-client
        - openssh-server
        - python3
      Host: {}
      Validation: {}
    nspawn:
      Exec:
        Boot: on
        LinkJournal: try-guest
        PrivateUsers: pick
      Files:
        PrivateUsersChown: on
      Network:
        Private: on
        VirtualEthernet: on
        Zone: nspawn
  {% endfor %}
{% endload %}


{% load_yaml as machine_defaults %}
# name of the nspawn container and name of the controlling systemd service
name: ""
# image: a image name created with eg. `image(name='focal', template='focal')`
image: focal
# enabled: if false, service will not get started and will be stopped if running
enabled: true
# ssh keys authorized for login
authorized_keys: ""
# script copied to and executed on target machine once, after creation of machine
postinst:
  # cat sshpublickeyfile | $0 <userid> <groupid> <username> <homedir>
  source: salt://systemd/nspawn/machine.postinst
  args: ['1000' , '1000', 'app', '/home/app']
# environment: dict of key,value pairs to be included in the target environment
environment: {}
# additional or overriding nspawn settings
nspawn:
  Exec: {}
  Files: {}
  Network: {}
{% endload %}

{%- set settings = salt['grains.filter_by']({'default': defaults},
  grain='default', default= 'default', merge= salt['pillar.get']('nspawn', {})) %}
